#!/bin/sh

set -e

RELEASE="$1"
test -n "$RELEASE" || { echo "usage: $(basename "$0") <release-version>"; exit 1; }

PROJECT="$(basename $PWD)"
TARGETDIR=".."

MANIFEST="$(mktemp)"
TEMP_DIR="$(mktemp -d)"

echo $MANIFEST

trap "rm -f \"${MANIFEST}\"; rm -rf \"${TEMP_DIR}\"" 0
git clone . "$TEMP_DIR/${PROJECT}_$RELEASE"
( set -e; cd "$TEMP_DIR" && rm -Rf "${PROJECT}_$RELEASE/.git"* )
( set -e; cd "$TEMP_DIR" && find "${PROJECT}_$RELEASE" -type f | sed 's/^\.*\/*//' | sort > "$MANIFEST" )
tar c -C "$TEMP_DIR" --owner 0 --group 0 --numeric-owner --no-recursion --files-from "$MANIFEST" | gzip -n > "$TARGETDIR/${PROJECT}_$RELEASE.tar.gz"



